## Detailed Report Editor – Architecture and Behavior

This document explains how the **Detailed Report Editor** works for radiology / detailed reports, with a focus on table handling and how it avoids corrupting report structures.

---

### 1. High‑level Flow

- **Where it's used**: `DetailedReportEditor` is rendered from `PatientReportDataFill` when a test has a reference point whose `testDescription` is `DETAILED REPORT`.
- **Core goals**:
  - Allow rich‑text editing (headings, paragraphs, lists, emphasis).
  - Allow **true tables** (rows/columns) that remain intact after editing.
  - Keep a **single source of truth** for detailed report content in `reportJson` without breaking existing APIs.

The overall flow:

1. **Load** existing `point.reportJson` from the backend.
2. **Normalize** it into the `ReportData` structure used by `DetailedReportEditor`.
3. Inside each section, content is edited via the **Tiptap‑based editor**.
4. On change, the editor emits **HTML**, which is stored in `ReportData.sections[i].content`.
5. When saving, `ReportData` is serialized as JSON and passed back to the parent via `onReportJsonChange`, which ultimately becomes the new `reportJson` stored by the API.
6. Anywhere the HTML is rendered (editor preview, confirmation dialog, final report preview), it is wrapped in a `.report-html` container so shared **global table styles** are applied.

---

### 2. Key Components

- **`DetailedReportEditor`**  
  Location: `src/app/(admin)/dashboard/sample/_component/Report/DetailedReportEditor.tsx`  
  Responsibilities:
  - Parse and normalize `point.reportJson` into a `ReportData` object.
  - Provide UI for managing **sections** (add, remove, reorder).
  - Handle "edit section" state and plug in the rich‑text editor.
  - Emit updated JSON up to the parent via `onReportJsonChange`.

- **`DetailedReportTiptapEditor`**  
  Location: `src/components/ui/detailed-report-tiptap-editor.tsx`  
  Responsibilities:
  - Provide the **Tiptap** rich‑text editor instance.
  - Support tables via Tiptap table extensions.
  - Accept **HTML string in** and emit **HTML string out**, so the rest of the app can continue treating section content as HTML.

---

### 3. Data Structures

- **`ReportSection`**
  - `id: string` – unique identifier per section.
  - `title: string` – section heading (e.g. "Formatted Report", "Impression").
  - `content: string` – HTML markup generated by Tiptap.
  - `type: 'text' | 'table' | 'list'` – currently informational; editor uses the same Tiptap instance for all.
  - `order: number` – used for sorting sections in display order.

- **`ReportData`**
  - `title: string` – overall report title (e.g. test name).
  - `description: string` – optional description.
  - `sections: ReportSection[]` – ordered list of sections.
  - `metadata` – optional author/date/version.

`ReportData` is serialized as JSON and stored in `point.reportJson` when the editor saves.

---

### 4. Tiptap Editor Configuration

**File**: `src/components/ui/detailed-report-tiptap-editor.tsx`

- Uses `@tiptap/react` with the following extensions:
  - `StarterKit` – paragraphs, headings, bold/italic, lists, etc.
  - `Table`, `TableRow`, `TableHeader`, `TableCell` – structured table support.
- Props:
  - `value: string` – HTML content for the section.
  - `onChange: (html: string) => void` – callback when content changes.
  - `height?: string` – minimum editor height (default `500px`).

Workflow:

1. **Initialization**  
   - The editor is created with `content: value || ""`.

2. **Updating from editor → parent**  
   - On any change (`onUpdate`), the editor calls `onChange(editor.getHTML())`.
   - `DetailedReportEditor` updates `editingSection.content` with this HTML.

3. **Syncing external value changes → editor**  
   - A `useEffect` watches `value`; if it differs from the current editor HTML, `setContent` is called, keeping the editor in sync with external changes.

4. **Styling the content**  
   - The editor content is wrapped in a `div` with `className="report-html ..."` so global table styles apply (see next section).

---

### 5. Table Styling and the `.report-html` Class

**File**: `src/app/globals.css`

Tables are no longer styled with inline `style=""` attributes. Instead, any rendered report HTML is wrapped in a container that uses the `.report-html` class. Global CSS applies consistent styling:

- `border-collapse: collapse;` and outer border on `<table>`.
- Cell borders and padding on `th` / `td`.
- Header background color for `thead th`.

Places where `.report-html` is used:

- Inside **`DetailedReportTiptapEditor`**:
  - The editor content wrapper uses `className="report-html prose ..."`, so tables look correct while editing.

- Inside **`DetailedReportEditor`** (non‑edit view for each section):
  - The `dangerouslySetInnerHTML` block for section content uses `className="report-html prose ..."`, so tables look the same as in the editor.

- Inside **confirmation dialog in `PatientReportDataFill`**:
  - The "Report Preview" content uses `className="report-html prose ..."`, so tables in the preview also show borders and proper layout.

This ensures that even though Tiptap strips the original inline styles when generating HTML, the **table structure is preserved** and the **visual grid is restored** consistently everywhere via shared CSS.

---

### 6. How This Avoids Past Problems

Previously:

- Tables were generated from structured JSON with inline styles and then passed through a non–table‑aware rich‑text editor, which flattened them into plain text.

Now:

- Tiptap understands tables as structured nodes (table → row → cell) and preserves that structure across edits.
- Inline styles are no longer required; all table visuals are controlled by global `.report-html` CSS.
- All views that show detailed report HTML (editor, section view, confirmation preview) share the same styling, so a table edited once does **not** visually break elsewhere.

---

### 7. Extending the Editor

If you want to extend behavior later, typical options are:

- Add more Tiptap extensions (e.g. underline, images) to `DetailedReportTiptapEditor`.
- Add a toolbar component around the editor to expose table actions (insert row/column, merge cells).
- Evolve `ReportSection.type` to drive different UIs for text‑only sections vs. data‑heavy sections.

These can all be done while keeping the same core flow: **Tiptap HTML stored in `ReportData.sections[].content`, styled via `.report-html`, and serialized as JSON in `reportJson`.**


